{% extends "base.html" %}

{% block content %}

<div class="auth-container">
    <div class="auth-box">
        <div style="margin-bottom: 30px">
            <div style="font-size: 28px; font-weight: 700; color: var(--text-main); margin-bottom: 10px;">
                Property<span style="color: var(--button-color)">Plus</span>
            </div>
            <p class="auth-subtitle" style="color: var(--text-muted)">
                Reset your password and regain access to your account.
            </p>
        </div>

        <div id="forgot-email-step">
            <div class="floating-group">
                <input type="email" id="forgot-email" placeholder=" " onkeyup="clearError('forgotEmailError')" />
                <label for="forgot-email">Email Address</label>
                <small id="forgotEmailError" class="text-danger"></small>
            </div>

            <button id="btn-send-forgot-otp" class="btn-primary full-width" onclick="sendForgotOTP()">
                Send Reset Code
            </button>

            <p class="auth-text" style="color: var(--text-muted); margin-top: 20px; text-align: center;">
                Remember your password?
                <a href="{{ url_for('auth.login') }}"
                    style="color: var(--text-main); text-decoration: underline; font-weight: 600">
                    Back to Login
                </a>
            </p>
        </div>

        <div id="forgot-otp-step" style="display: none">
            <div class="otp-wrapper">
                <div class="otp-message">
                    <div class="otp-message-title" style="color: var(--text-main);">We've sent a reset code to your
                        email</div>
                    <div class="otp-message-sub" style="color: var(--text-muted);">Sent to <span
                            id="forgot-masked-email" class="otp-email"
                            style="color: var(--text-main); font-weight: bold;">your email</span></div>
                </div>

                <label class="otp-label" style="color: var(--text-muted);">Enter 6-digit Reset Code</label>

                <div class="otp-row" role="group" aria-label="6-digit OTP input">
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 1" />
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 2" />
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 3" />
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 4" />
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 5" />
                    <input class="otp-digit forgot-otp-digit" inputmode="numeric" pattern="\d*" maxlength="1"
                        aria-label="Digit 6" />
                </div>

                <small id="forgotOtpError" class="text-danger"></small>
            </div>

            <button id="btn-verify-forgot-otp" class="btn-primary full-width" onclick="verifyForgotOTP()">
                Verify Code
            </button>

            <p class="auth-text" style="color: var(--text-muted); margin-top: 15px">
                Didn't receive code? <br />
                <a id="forgot-resend-link" class="disabled" style="color: var(--button-color); cursor: pointer;"
                    onclick="resendForgotOTP()">Resend Code</a>
                <span id="forgot-timer-text" style="color: var(--text-muted)">in 00:30</span>
            </p>
        </div>

        <div id="forgot-password-step" style="display: none">
            <div class="floating-group">
                <input type="password" id="new-password" placeholder=" " />
                <label for="new-password">Create New Password</label>
                <i class="fas fa-eye password-toggle" onclick="togglePassword('new-password', this)"></i>
            </div>

            <div id="new-password-criteria" style="margin-bottom: 20px; font-size: 13px; color: var(--text-muted)">
                <p style="margin-bottom: 5px">Password must contain:</p>
                <span id="new-crit-len" style="margin-right: 10px">❌ 8+ Chars</span>
                <span id="new-crit-num" style="margin-right: 10px">❌ Number</span>
                <span id="new-crit-spec" style="margin-right: 10px">❌ Special Char (@#$%)</span>
            </div>

            <div class="floating-group">
                <input type="password" id="confirm-new-password" placeholder=" " />
                <label for="confirm-new-password">Confirm New Password</label>
                <i class="fas fa-eye password-toggle" onclick="togglePassword('confirm-new-password', this)"></i>
                <small id="newPasswordMatchError" class="text-danger" style="display: none">
                    Passwords do not match
                </small>
            </div>

            <button id="btn-reset-password" class="btn-primary full-width" onclick="resetPassword()" disabled
                style="opacity: 0.6; cursor: not-allowed;">
                Update Password
            </button>
        </div>

        <div id="forgot-success-step" style="display: none; text-align: center">
            <div class="success-animation">
                <div class="decorations">
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                    <div class="dec"></div>
                </div>
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                </svg>
            </div>

            <h3 style="color: var(--text-main); margin-bottom: 20px; font-weight: 700;">Password Updated!</h3>
            <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
                Your password has been reset successfully.<br>You can now login with your new credentials.
            </p>

            <a href="{{ url_for('auth.login') }}" class="btn-primary full-width">
                Back to Login
            </a>
        </div>
    </div>
</div>

<script>
    // --- YOUR ORIGINAL SCRIPT ---
    document.addEventListener("DOMContentLoaded", function () {
        setupForgotOTPListeners();
    });

    function setupForgotOTPListeners() {
        const otpDigits = document.querySelectorAll(".forgot-otp-digit");
        const verifyBtn = document.getElementById("btn-verify-forgot-otp");

        function otpComplete() {
            if (!otpDigits || otpDigits.length !== 6) return false;
            for (let i = 0; i < otpDigits.length; i++) {
                if (!otpDigits[i].value || otpDigits[i].value.length !== 1) return false;
            }
            return true;
        }

        function updateOtpButton() {
            if (!verifyBtn) return;
            let ok = otpComplete();
            verifyBtn.disabled = !ok;
            verifyBtn.style.opacity = ok ? "1" : "0.6";
            verifyBtn.style.cursor = ok ? "pointer" : "not-allowed";
        }

        function cleanOneDigit(value) {
            if (!value) return "";
            value = value.replace(/[^0-9]/g, "");
            return value.substring(0, 1);
        }

        function resetOtpState(el) {
            if (!el) return;
            el.classList.remove("is-green");
            el.classList.remove("is-red");
        }

        function handleOtpInput(e) {
            let input = e.target;
            let idx = parseInt(input.getAttribute("data-otp-index"), 10);

            resetOtpState(input);
            input.value = cleanOneDigit(input.value);
            input.classList.toggle("filled", !!input.value);

            if (input.value && idx < otpDigits.length - 1) {
                otpDigits[idx + 1].focus();
            }
            updateOtpButton();
        }

        function handleOtpKeydown(e) {
            let input = e.target;
            let idx = parseInt(input.getAttribute("data-otp-index"), 10);

            if (e.key && e.key.length === 1 && !e.ctrlKey && !e.metaKey && !/^\d$/.test(e.key)) {
                e.preventDefault();
                return;
            }

            if (e.key === "Backspace" && !input.value && idx > 0) {
                e.preventDefault();
                otpDigits[idx - 1].focus();
            }
        }

        for (let i = 0; i < otpDigits.length; i++) {
            otpDigits[i].setAttribute("data-otp-index", i);
            otpDigits[i].addEventListener("input", handleOtpInput);
            otpDigits[i].addEventListener("keydown", handleOtpKeydown);
        }

        let otpRow = document.querySelector("#forgot-otp-step .otp-row");
        if (otpRow) {
            otpRow.addEventListener("paste", function (e) {
                let text = (e.clipboardData || window.clipboardData).getData("text");
                if (!text) return;
                let digits = text.replace(/[^0-9]/g, "").slice(0, 6);
                if (!digits) return;

                e.preventDefault();
                for (let j = 0; j < otpDigits.length; j++) {
                    otpDigits[j].value = digits[j] || "";
                    otpDigits[j].classList.toggle("filled", !!otpDigits[j].value);
                    resetOtpState(otpDigits[j]);
                }
                updateOtpButton();
                if (otpComplete()) {
                    verifyForgotOTP();
                }
            });
        }

        updateOtpButton();
        if (otpDigits.length > 0) otpDigits[0].focus();

        const newPassInput = document.getElementById("new-password");
        const confirmPassInput = document.getElementById("confirm-new-password");

        if (newPassInput) {
            newPassInput.addEventListener("keyup", () => {
                checkNewPasswordStrength(newPassInput.value);
                if (confirmPassInput.value.length > 0) checkNewPasswords();
            });
        }

        if (confirmPassInput) {
            confirmPassInput.addEventListener("keyup", checkNewPasswords);
            confirmPassInput.addEventListener("input", checkNewPasswords);
        }
    }

    function checkNewPasswordStrength(p) {
        const hasLen = p.length >= 8;
        const hasNum = /\d/.test(p);
        const hasSpec = /[!@#$%^&*(),.?":{}|<>]/.test(p);

        const lenEl = document.getElementById("new-crit-len");
        const numEl = document.getElementById("new-crit-num");
        const specEl = document.getElementById("new-crit-spec");

        if (lenEl) {
            lenEl.innerText = hasLen ? "✅ 8+ Chars" : "❌ 8+ Chars";
            lenEl.style.color = hasLen ? "#2dce89" : "#ff3333";
        }
        if (numEl) {
            numEl.innerText = hasNum ? "✅ Number" : "❌ Number";
            numEl.style.color = hasNum ? "#2dce89" : "#ff3333";
        }
        if (specEl) {
            specEl.innerText = hasSpec ? "✅ Special" : "❌ Special";
            specEl.style.color = hasSpec ? "#2dce89" : "#ff3333";
        }

        return hasLen && hasNum && hasSpec;
    }

    function checkNewPasswords() {
        const p = document.getElementById("new-password").value;
        const cp = document.getElementById("confirm-new-password").value;
        const matchError = document.getElementById("newPasswordMatchError");
        const btn = document.getElementById("btn-reset-password");

        let matches = true;
        if (cp.length === 0) {
            if (matchError) matchError.style.display = "none";
            matches = true;
        } else if (p === cp) {
            if (matchError) matchError.style.display = "none";
            matches = true;
        } else {
            if (matchError) matchError.style.display = "block";
            matches = false;
        }

        const valid = checkNewPasswordStrength(p) && matches && cp.length > 0;
        if (btn) {
            btn.disabled = !valid;
            btn.style.opacity = valid ? "1" : "0.6";
            btn.style.cursor = valid ? "pointer" : "not-allowed";
        }
    }

    function clearError(elementId) {
        const el = document.getElementById(elementId);
        if (el) el.innerText = "";
    }

    // --- FUNCTION API CALLS (Implied from your logic) ---

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    let userForgotEmail = "";

    async function sendForgotOTP() {
        const emailInput = document.getElementById("forgot-email");
        const emailError = document.getElementById("forgotEmailError");
        const btn = document.getElementById("btn-send-forgot-otp");
        userForgotEmail = emailInput.value.trim();

        if (!userForgotEmail) {
            if (emailError) emailError.innerText = "Email is required";
            return;
        }
        if (!validateEmail(userForgotEmail)) {
            if (emailError) emailError.innerText = "Please enter a valid email address";
            return;
        }

        btn.innerText = "Sending...";
        btn.disabled = true;

        try {
            const response = await fetch("/api/send-forgot-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userForgotEmail })
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById("forgot-email-step").style.display = "none";
                document.getElementById("forgot-otp-step").style.display = "block";
                document.getElementById("forgot-masked-email").innerText = userForgotEmail;
                // Start Timer
                if (typeof startForgotResendTimer === "function") {
                    startForgotResendTimer();
                }
                // Focus on first OTP input
                setTimeout(() => {
                    const firstOtp = document.querySelector(".forgot-otp-digit");
                    if (firstOtp) firstOtp.focus();
                }, 100);
            } else {
                if (emailError) emailError.innerText = data.message || "Error sending OTP";
            }
        } catch (e) {
            console.error(e);
            if (emailError) emailError.innerText = "Network Error. Please try again.";
        }
        finally { btn.innerText = "Send Reset Code"; btn.disabled = false; }
    }

    async function verifyForgotOTP() {
        const digits = document.querySelectorAll(".forgot-otp-digit");
        const otpError = document.getElementById("forgotOtpError");
        let otp = "";
        digits.forEach(d => otp += d.value);

        if (otp.length < 6) {
            if (otpError) otpError.innerText = "Please enter the 6-digit code";
            return;
        }

        try {
            const response = await fetch("/api/verify-forgot-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userForgotEmail, otp: otp })
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById("forgot-otp-step").style.display = "none";
                document.getElementById("forgot-password-step").style.display = "block";
            } else {
                if (otpError) {
                    otpError.innerText = "Invalid or expired code";
                    digits.forEach(d => {
                        d.classList.add("is-red");
                        d.value = "";
                    });
                    if (digits[0]) digits[0].focus();
                }
            }
        } catch (e) {
            if (otpError) otpError.innerText = "Error verifying code";
        }
    }

    async function resetPassword() {
        const newPass = document.getElementById("new-password").value;
        const confirmPass = document.getElementById("confirm-new-password").value;
        const btn = document.getElementById("btn-reset-password");

        if (!checkNewPasswordStrength(newPass)) {
            return;
        }

        if (newPass !== confirmPass) {
            document.getElementById("newPasswordMatchError").style.display = "block";
            return;
        }

        btn.innerText = "Updating...";
        btn.disabled = true;

        try {
            const response = await fetch("/api/reset-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userForgotEmail, new_password: newPass })
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById("forgot-password-step").style.display = "none";
                document.getElementById("forgot-success-step").style.display = "block";
            } else {
                alert(data.message || "Failed to reset password");
            }
        } catch (e) {
            console.error(e);
            alert("Error updating password. Please try again.");
        } finally {
            btn.innerText = "Update Password";
            btn.disabled = false;
        }
    }

    function togglePassword(id, icon) {
        const input = document.getElementById(id);
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
        }
    }
</script>

{% endblock %}